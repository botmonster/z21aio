#!/bin/sh
#
# Pre-commit hook that runs flake8 and pytest checks
# Similar to .github/workflows/python-package.yml but uses current venv
#
# To enable this hook, run:
#   git config core.hooksPath .githooks
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# Detect Python executable (prefer venv)
if [ -f ".venv/Scripts/python.exe" ]; then
    # Windows venv
    PYTHON=".venv/Scripts/python.exe"
elif [ -f ".venv/bin/python" ]; then
    # Unix venv
    PYTHON=".venv/bin/python"
else
    PYTHON="python"
fi

echo "Using Python: $PYTHON"

# Check if flake8 is available
if ! $PYTHON -m flake8 --version > /dev/null 2>&1; then
    echo "${RED}Error: flake8 is not installed. Run: pip install flake8${NC}"
    exit 1
fi

# Check if pytest is available
if ! $PYTHON -m pytest --version > /dev/null 2>&1; then
    echo "${RED}Error: pytest is not installed. Run: pip install pytest${NC}"
    exit 1
fi

# Lint with flake8 - stop on syntax errors or undefined names
echo ""
echo "${YELLOW}Running flake8 (critical errors)...${NC}"
$PYTHON -m flake8 ./src --count --select=E9,F63,F7,F82 --show-source --statistics
FLAKE8_CRITICAL=$?

if [ $FLAKE8_CRITICAL -ne 0 ]; then
    echo "${RED}Flake8 found critical errors (syntax errors or undefined names). Commit aborted.${NC}"
    exit 1
fi
echo "${GREEN}No critical flake8 errors found.${NC}"

# Lint with flake8 - warnings (non-blocking, just informational)
echo ""
echo "${YELLOW}Running flake8 (warnings)...${NC}"
$PYTHON -m flake8 ./src --count --exit-zero --max-complexity=20 --max-line-length=127 --statistics

# Run pytest
echo ""
echo "${YELLOW}Running pytest...${NC}"
$PYTHON -m pytest tests/ -v
PYTEST_RESULT=$?

if [ $PYTEST_RESULT -ne 0 ]; then
    echo "${RED}Pytest failed. Commit aborted.${NC}"
    exit 1
fi

echo ""
echo "${GREEN}All pre-commit checks passed!${NC}"
exit 0
